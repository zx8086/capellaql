---
# =============================================================================
# .github/workflows/cve-monitoring.yml
# Phase 4: SIO-419 - 6-hour CVE monitoring workflow
# =============================================================================

name: CVE Monitoring

on:
  schedule:
    - cron: "0 */6 * * *"  # Every 6 hours
  workflow_dispatch:

env:
  REGISTRY: docker.io
  IMAGE_NAME: zx8086/capellaql

permissions:
  contents: read
  security-events: write
  issues: write

jobs:
  # ==========================================================================
  # Job 1: Check Base Image CVEs
  # ==========================================================================
  base-image-cve:
    name: Base Image CVE Check
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check distroless image for CVEs
        uses: aquasecurity/trivy-action@0.28.0
        id: trivy-distroless
        with:
          image-ref: "gcr.io/distroless/static-debian12:nonroot"
          format: "json"
          output: "distroless-cve.json"
          severity: "CRITICAL,HIGH"
          vuln-type: "os"
        continue-on-error: true

      - name: Check Bun Alpine image for CVEs
        uses: aquasecurity/trivy-action@0.28.0
        id: trivy-bun
        with:
          image-ref: "oven/bun:1.1-alpine"
          format: "json"
          output: "bun-cve.json"
          severity: "CRITICAL,HIGH"
          vuln-type: "os"
        continue-on-error: true

      - name: Parse CVE findings
        id: cve-count
        run: |
          DISTROLESS_CRITICAL=0
          DISTROLESS_HIGH=0
          BUN_CRITICAL=0
          BUN_HIGH=0

          if [ -f distroless-cve.json ]; then
            DISTROLESS_CRITICAL=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity == "CRITICAL")] | length' distroless-cve.json 2>/dev/null || echo "0")
            DISTROLESS_HIGH=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity == "HIGH")] | length' distroless-cve.json 2>/dev/null || echo "0")
          fi

          if [ -f bun-cve.json ]; then
            BUN_CRITICAL=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity == "CRITICAL")] | length' bun-cve.json 2>/dev/null || echo "0")
            BUN_HIGH=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity == "HIGH")] | length' bun-cve.json 2>/dev/null || echo "0")
          fi

          echo "DISTROLESS_CRITICAL=${DISTROLESS_CRITICAL}" >> $GITHUB_OUTPUT
          echo "DISTROLESS_HIGH=${DISTROLESS_HIGH}" >> $GITHUB_OUTPUT
          echo "BUN_CRITICAL=${BUN_CRITICAL}" >> $GITHUB_OUTPUT
          echo "BUN_HIGH=${BUN_HIGH}" >> $GITHUB_OUTPUT

          TOTAL_CRITICAL=$((DISTROLESS_CRITICAL + BUN_CRITICAL))
          echo "TOTAL_CRITICAL=${TOTAL_CRITICAL}" >> $GITHUB_OUTPUT

      - name: Create issue for critical base image CVEs
        if: steps.cve-count.outputs.TOTAL_CRITICAL != '0'
        uses: actions/github-script@v7
        with:
          script: |
            const distrolessCritical = '${{ steps.cve-count.outputs.DISTROLESS_CRITICAL }}';
            const distrolessHigh = '${{ steps.cve-count.outputs.DISTROLESS_HIGH }}';
            const bunCritical = '${{ steps.cve-count.outputs.BUN_CRITICAL }}';
            const bunHigh = '${{ steps.cve-count.outputs.BUN_HIGH }}';

            // Check if similar issue already exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'cve-base-image'
            });

            const existingIssue = issues.data.find(issue =>
              issue.title.includes('Base image CVE')
            );

            if (existingIssue) {
              // Update existing issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: `## CVE Monitoring Update - ${new Date().toISOString()}

            ### Current Status
            | Image | Critical | High |
            |-------|----------|------|
            | gcr.io/distroless/static-debian12:nonroot | ${distrolessCritical} | ${distrolessHigh} |
            | oven/bun:1.1-alpine | ${bunCritical} | ${bunHigh} |

            *Automated update from CVE monitoring workflow*`
              });
            } else {
              // Create new issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `[CVE] Base image CVE detected - ${new Date().toISOString().split('T')[0]}`,
                body: `## Base Image CVE Alert

            Critical CVEs have been detected in base images:

            | Image | Critical | High |
            |-------|----------|------|
            | gcr.io/distroless/static-debian12:nonroot | ${distrolessCritical} | ${distrolessHigh} |
            | oven/bun:1.1-alpine | ${bunCritical} | ${bunHigh} |

            ### Recommended Actions
            1. Check for updated base images
            2. Rebuild container with patched base image
            3. Update Dockerfile if new base image version available

            ---
            *This issue was automatically created by CVE monitoring.*`,
                labels: ['security', 'cve-base-image', 'automated']
              });
            }

  # ==========================================================================
  # Job 2: Check Production Image CVEs
  # ==========================================================================
  production-image-cve:
    name: Production Image CVE Check
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}

      - name: Pull latest production image
        run: |
          docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest || echo "Image not found"

      - name: Scan production image
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: "${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest"
          format: "sarif"
          output: "production-cve.sarif"
          severity: "CRITICAL,HIGH"
          vuln-type: "os,library"
          ignore-unfixed: true
        continue-on-error: true

      - name: Upload SARIF to GitHub Security
        if: hashFiles('production-cve.sarif') != ''
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: production-cve.sarif
          category: cve-monitoring-production
        continue-on-error: true

  # ==========================================================================
  # Job 3: Summary
  # ==========================================================================
  summary:
    name: CVE Monitoring Summary
    needs: [base-image-cve, production-image-cve]
    if: always()
    runs-on: ubuntu-latest

    steps:
      - name: Generate summary
        run: |
          {
            echo "## CVE Monitoring Report"
            echo ""
            echo "**Scan Time:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
            echo ""
            echo "### Scan Results"
            echo "| Check | Status |"
            echo "|-------|--------|"
            echo "| Base Image CVEs | ${{ needs.base-image-cve.result }} |"
            echo "| Production Image CVEs | ${{ needs.production-image-cve.result }} |"
            echo ""
            echo "### Images Scanned"
            echo "- gcr.io/distroless/static-debian12:nonroot"
            echo "- oven/bun:1.1-alpine"
            echo "- ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest"
            echo ""
            echo "*Next scan in 6 hours*"
          } >> $GITHUB_STEP_SUMMARY
